@page "/"
@using ClimaticsLang.Lang
@using ItemsLang.Lang
@using LaMision.Core
@using LaMision.Core.Lang
@using LaMision.Core.Vaults
@using Languager
@using MappingLang.Lang
@using Outputer
@using Outputer.Choicing
@using Stories

<PageTitle>La Misión (Rayuela de arena 2024)</PageTitle>

@if(output is not null)
{
    foreach (var item in output.Pharagraphs)
    {
        <p role="contentinfo">@item.ToString()</p>
    }

    foreach (var item in output.Conversations)
    {
        <p role="contentinfo">@item.ToString()</p>
    }
}

<div>
    @if (interaction is null || !interaction.HasChoices || interaction.Choices.IsEmpty)
    {
        <div role="option">
            <button class="btn btn-primary" @onclick="Continue">Continuar</button>
        </div>
    }
    else
    {
        foreach (var option in interaction.Choices.Options)
        {
            <div role="option">
                <button class="btn btn-primary" @onclick="() => onOptionSelected(option.Index)">@option.Value</button>
            </div>
        }
    }
</div>

@code {
    private Output? output;

    private GameInteraction? interaction = null;
    private Input input = Input.Void;

    private Game game = new Game(
            Language.ES,
            WorldBuilder.Build(),
            new DictionaryProvider[]
            {
                new MisionDictionaryProvider(),
                new MisionItemsDictionaryProvider(),
                new MisionMappedsProvider(),
                new ItemsDictionaryProvider(),
                new MappingDictionaryProvider(),
                new ClimaticsDictionaryProvider()
            },
            new StoriesVault[]
            {
                BasicVault.Get()
            });

    protected override void OnInitialized()
    {
        output = game.Start();
    }

    private void onOptionSelected(int index)
    {
        input = new Input(index, interaction!.Choices.Range);
        interaction = game.NextAction(input);

        if (interaction.HasText)
            output = interaction.Output;
    }

    private void Continue()
    {
        interaction = game.NextAction(Input.Void);

        if (interaction.HasText)
            output = interaction.Output;
    }
}